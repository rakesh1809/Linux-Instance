{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Creating a windows webservices server for dotnet application in test2",
   "Outputs":{

   },
   "Mappings":{
      "EnvMap":{
         "test2":{
            "InstanceType":"m3.large",
            "SubnetId":"subnet-0aab8183c0f778d19",
            "AvailabilityZone":"us-east-1a",
            "SnapshotIdEC2":"snap-0b4363f231bca7911",
            "SecurityGroups":[
               "sg-0f9eaf999d6fe55f3",
               "sg-0f9eaf999d6fe55f3",
               "sg-04a320bc9624ab649"
            ]
         }
      }
   },
   "Parameters":{
      "Environment":{
         "Description":"Gives the environment of the instance e.g. test2",
         "Type":"String",
         "Default":"test2"
      },
      "ImageId":{
         "Description":"Provides the unique ID of the Amazon Machine Image (AMI)",
         "Type":"AWS::EC2::Image::Id",
         "Default":"ami-05a73ba9b58b8f493"
      }
   },
   "Resources":{
      "EC2Instance":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "ImageId":{
               "Ref":"ImageId"
            },
            "InstanceType":{
               "Fn::FindInMap":[
                  "EnvMap",
                  {
                     "Ref":"Environment"
                  },
                  "InstanceType"
               ]
            },
            "BlockDeviceMappings":[
               {
                  "DeviceName":"/dev/sda1",
                  "Ebs":{
                     "VolumeSize":"100",
                     "VolumeType":"gp2"
                  }
               }
            ],
            "SecurityGroupIds":{
               "Fn::FindInMap":[
                  "EnvMap",
                  {
                     "Ref":"Environment"
                  },
                  "SecurityGroups"
               ]
            },
            "KeyName":"HIOS-TEST-2",
            "IamInstanceProfile": "HIOS-EC2-S3-Limited-Access-Role",
            "SubnetId":"subnet-0aab8183c0f778d19",
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "",
                     [
                        "<powershell>\n",
                        "Initialize-Disk -Number 1\n",
                        "New-Parition -DiskNumber 1 -DriveNumber D -UseMaximumSize\n",
                        "Set-Disk -Number 1 -IsOffline $False\n",
                        "Set-Disk -Number 1 -IsReadonly $False\n",
                        "cd D:\n",
                        "aws s3 cp s3://dotnet-files/ . --recursive\n",
                        "Invoke-Command -FilePath D:\\dotnet-ui-deployment.ps1\n",
                        "exec > >(tee /var/log/user-data.log|logger -t user-data ) 2>&1 \n",
                        "<powershell>"
                     ]
                  ]
               }
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"HIOS-TEST2-AL-DOTNET-UI-01"
               },
               {
                  "Key":"application",
                  "Value":"hios"
               },
               {
                  "Key":"business",
                  "Value":"UI"
               },
               {
                  "Key":"stack",
                  "Value":"test2"
               },
               {
                  "Key":"CPMBackup",
                  "Value":"4HR"
               }
            ],
            "Volumes":[
               {
                  "VolumeId":{
                     "Ref":"HIOStest2"
                  },
                  "Device":"/dev/xvdf"
               }
            ]
         }
      },
      "HIOStest2":{
         "Type":"AWS::EC2::Volume",
         "Properties":{
            "AvailabilityZone":{
               "Fn::FindInMap":[
                  "EnvMap",
                  {
                     "Ref":"Environment"
                  },
                  "AvailabilityZone"
               ]
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"HIOS-TEST2-AL-DOTNET-UI-01"
               },
               {
                  "Key":"application",
                  "Value":"hios"
               },
               {
                  "Key":"business",
                  "Value":"UI"
               },
               {
                  "Key":"stack",
                  "Value":"test2"
               },
               {
                  "Key":"CPMBackup",
                  "Value":"4HR"
               }
            ],
            "SnapshotId":{
               "Fn::FindInMap":[
                  "EnvMap",
                  {
                     "Ref":"Environment"
                  },
                  "SnapshotIdEC2"
               ]
            },
            "Size":"100",
            "VolumeType":"gp2"
         }
      }
   }
}
